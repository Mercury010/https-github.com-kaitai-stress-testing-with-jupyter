---
title: "Sleep Questionnaire Data"
author: "Kaisa Taipale"
date: "July 29, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## What is this?

Here I'm doing my own initial exploration of the data provided by Sunny. 
My plan is to load the data and combine test and training data to make one big dataset for exploration of missingness, distributions of variables, and data quality. Then I'll split it up for machine learning purposes. 

```{r libraries used}
library(ggplot2)
library(tidyverse)
library(GGally)
library(randomForest)
library(calibrate)
```

```{r load the data}
survey_train <- read.csv("~/Documents/DataViz/WiSDM project 2019/survey_train.csv")
survey_test <- read.csv("~/Documents/DataViz/WiSDM project 2019/survey_test.csv")
```

```{r dimensions}
dim(survey_test)
dim(survey_train)
```

Note that the datasets have different dimensions. Sunny noted in her other R code that for the test set she dropped columns 61, 81, and 151 as "meaningless variables". What are these? 

```{r variables to drop}
colnames(survey_test)[61]
colnames(survey_test)[81]
colnames(survey_test)[151]
```

I see: they primarily indicate if there are any NAs in the respondent's answers. We can indeed drop those.

```{r drop completeness scores}
survey_test <- survey_test[,c(-61, -81, -151)]
```

Now that we've done that, we can glue the two sets.

```{r bind together to one file for exploration}
survey_all <- rbind(survey_test, survey_train)
```

For laziness, use the summary function first!

```{r summarize it}
summary(survey_all)
```
Now missingness: what's the missingness like by variable?

```{r variable missingness}
colSums(is.na(survey_all))
```
 
The demographics are almost all missing -- I have 105 missing values for age, height, weight, bmi. The QL child reports are also highly missing, and the QL parent responses somewhat missing.... Craniofacial data are all there (zero missing!).
 
```{r respondent missingness}
rowSums(is.na(survey_all))
hist(rowSums(is.na(survey_all)))
```
Just looking at this, I'm tempted to put a cutoff of 50 missing -- if we do that, 5 respondents would be dropped. This is an arbitrary number.

## Visualizations

### Histograms of numeric responses
Before dropping any missing values, let's do some visualization of distributions of answers. 

First I'll create a column from the record_id that is binary and identifies each patient as having the problem (CF records) or not having the problem (Control records). Then I'll drop all the columns that are characters etc, retaining only columns that are numeric. Last, in this part, I'll graph control against patient for numeric responses. 


To create the patient-or-control column, I'm going to be lazy and simply extract the first two characters of the record_id column and make that my factor!
```{r create patient or control column}
survey_all$patient <- factor(substr(survey_all$record_id, start = 1, stop = 2))
```

Now let's create a dataframe that consists only of numeric columns. We will also drop height, age, weight, and bmi: there are so many missing values that they're essentially useless. 

Moreover, I'm going to drop gender, person_completing_form, osa_overall, and psq_total_yes. In previous work gender has not proved to be significant, and indeed a visual inspection indicates there's not a lot of difference. The same is true for sex, another column!
```{r histogram of gender}
ggplot(survey_all,aes(x=gender,group=patient,fill=patient))+
     geom_histogram(position="dodge",binwidth=0.25)+theme_bw()
```

Person_completing_form is not a clinical presentation, and osa_overall and psq_total_yes are summary variables -- I don't like including summary variables in SVD exploration because they inevitably show up as more important than all their components. 


```{r numbers only}
nums <- unlist(lapply(survey_all, is.numeric)) 
numbers_only <- survey_all[ , nums]
numbers_only <- numbers_only[, -which(names(numbers_only) %in% c("age","weight","height","bmi", "gender","sex", "person_completing_form", "psq_total_yes","osa_overall"))]
```

This numeric-only dataframe will be helpful when we carry out SVD. We'll glue back on the factors corresponding to patient or control to color accordingly; we can also use that right now in constructing ggplot histograms. 

```{r numbers only with factor}
numbers_and_status <- numbers_only 
numbers_and_status$patient <- survey_all$patient
```

Time for the histograms! Ok -- didn't finish this :) will come back.
```{r histogram visualization}

```

# Some data management

Since I'm only exploring data right now, I'm not going to do the train-test split yet -- just impute for everything (!) and then do SVD.
## Imputation of missing values

Here I'm using Sunny's code and just using random forest for imputation of missing values.


```{r impute missing values}
numbers_imputed <- rfImpute(numbers_and_status, y = numbers_and_status$patient,  iter=5, ntree=300)
```

## Singular value decomposition on imputed data

Now I'll do some singular value decomposition as I love to look at SVD for understanding! I will scale the answers, as otherwise night waking minutes and sleepmin will take over the answers.

```{r singular value decomposition}
svd_on_responses <- svd(scale(numbers_imputed[, -which(names(numbers_imputed) %in% c("patient","numbers_and_status$patient"))]))

```

Look at the distribution of singular values:

```{r singular values}
svd_on_responses$d/sum(svd_on_responses$d)
```
Looking at the cumulative sum of singular values, it's clear that many variables are close in importance.
```{r cumulative sum of singular values}
cumsum(svd_on_responses$d/sum(svd_on_responses$d))
```

Look at plot of patients:
```{r plot of patients svd}
plot(svd_on_responses$u[,1],svd_on_responses$u[,2])
```
Look at plot of survey responses:
```{r plot of responses svd components 1-2}
plot(svd_on_responses$v[,1],svd_on_responses$v[,2], xlim = c(-.15,.18), ylim = c(-.24,.2))
textxy(svd_on_responses$v[,1],svd_on_responses$v[,2], colnames(numbers_imputed[, -which(names(numbers_imputed) %in% c("patient","numbers_and_status$patient"))]))

```
Time to make this prettier and color by factor. Need some dataframes to use ggplot.

```{r dataframe the svd}
svd_people_df <- data.frame(svd_on_responses$u)
svd_people_df$patient <- numbers_and_status$patient
```
```{r ggplot the svd on patients}
p <- ggplot(data.frame(svd_people_df), aes(x=X1, y=X2, color = as.factor(patient)))
p+geom_point(alpha=0.8)+scale_fill_brewer(palette="Set1")
```

Cool. There's definitely some differentiation simply based on questionnaire responses. Does this also hold in the next few dimensions?
```{r ggplot the svd on patients X2-X3}
p <- ggplot(data.frame(svd_people_df), aes(x=X2, y=X3, color = as.factor(patient)))
p+geom_point(alpha=0.8)+scale_fill_brewer(palette="Set1")
```

Very weird graphing second and third singular components against each other!!!! Like a bullseye instead of a linear separation. What are the variables that go with this?

```{r plot of responses svd components 2-3}
plot(svd_on_responses$v[,2],svd_on_responses$v[,3], xlim = c(-.27,.2), ylim = c(-.24,.2))
textxy(svd_on_responses$v[,2],svd_on_responses$v[,3], colnames(numbers_imputed[, -which(names(numbers_imputed) %in% c("patient","numbers_and_status$patient"))]))

```

On the left-hand side (for the moment) are variables about forgetting, teasing, friends, while on the right-hand side (for the moment) are variables about choking, gasping, swallowing. 

```{r ggplot the svd on patients X1-X3}
p <- ggplot(data.frame(svd_people_df), aes(x=X1, y=X3, color = as.factor(patient)))
p+geom_point(alpha=0.8)+scale_fill_brewer(palette="Set1")
```

X1 against X3 certainly has a more linear separation boundary.

Ok. What I conclude from this exercise is that there's a strong linear effect initially, but then there is some lower-lying nonlinear behavior that needs to be addressed somehow. 

I'd like to talk with a domain expert about what we see with the factors from the questionnaire. I see patterns, but don't know enough about the topic to know how to exploit them. From my limited understanding based in part on covertly reading my husband's medical journals, there are often distinct problems with similar presentations, and so further methods should be pursued to see if there might be mixtures presenting with the same clinical diagnosis.

One such avenue would be using clustering on symptoms/survey responses, as well as on patients, and then following up with (for instance) some topological data analysis to contrast with the clustering results. 
